/*! df-tab-menu - v0.3.0 - Responsive tabs with dropdown menu - built 2016-04-07 - License MIT (http://www.opensource.org/licenses/MIT) */
!function(){"use strict";angular.module("digitalfondue.dftabmenu",[]).directive("dfTabMenu",["$window","$timeout","haparaClientBus",function($window,$timeout,haparaClientBus){return{restrict:"A",priority:2001,compile:function($element,$attrs,$rootScope){function bootstrap(s){return addBootstrapTheme?s:""}function bootstrapDropDownMenu(s){return addBootstrapDropDownMenu?s:""}var doc=$window.document,root=$element[0],baseTag=root.tagName;if("UL"!==baseTag&&"OL"!==baseTag)throw"Wrong element: only OL and UL are supported by df-tab-menu";var addBootstrapTheme="bootstrap"===$attrs.theme,addBootstrapDropDownMenu="bootstrap"===$attrs.themeDropDownMenu;angular.element(root).attr("role","tablist").addClass("df-tab-menu "+bootstrap("nav nav-tabs"));var moreMenuElement=angular.element(root.querySelector("li[data-more-menu-item]"));moreMenuElement.attr({role:"presentation"}),moreMenuElement.addClass(bootstrap("dropdown")),moreMenuElement.addClass(bootstrapDropDownMenu("dropdown")),moreMenuElement.children().attr({"dropdown-toggle":"","aria-haspopup":"true","aria-expanded":"false"}),moreMenuElement.children().addClass("dropdown-toggle"),moreMenuElement.append("<"+baseTag+' role="menu" aria-hidden="true" class="df-tab-menu-dropdown '+bootstrap("dropdown-menu")+bootstrapDropDownMenu("dropdown-menu")+'"></'+baseTag+">");for(var moreList=angular.element(root.querySelector(".df-tab-menu-dropdown")),moreElements=root.querySelectorAll("li[data-menu-item]"),elements=angular.element(moreElements),e=0;e<elements.length;e++){var newElement=angular.element(moreElements[e]).clone();newElement.attr({role:"menuitem"}),moreList.append(newElement),angular.element(moreElements[e]).attr({role:"presentation"}),angular.element(moreElements[e]).children().attr({"aria-selected":"false",role:"tab"})}return function($scope,$element,$attrs){var root=$element[0],wdw=angular.element($window),dropdownOpen=!1,getElementsSize=function(){var elements=root.querySelectorAll("li[data-menu-item][role=presentation]");angular.element(elements).removeClass("ng-hide");for(var elementsSize=[],e=0;e<elements.length;e++){var size=elements[e].offsetWidth;size>0&&(elementsSize[e]=elements[e].offsetWidth)}return elementsSize},getMoreElementSize=($scope.$watch(function(){var element=root.querySelector("li[role=presentation].df-tab-menu-active");return null!=element?element.scrollWidth:0},function(w,oldW){null!=w&&w>0&&buildMenu()},!0),function(){return angular.element(root.querySelector("li[data-more-menu-item]")).removeClass("ng-hide"),root.querySelector("li[data-more-menu-item]").offsetWidth}),getVisibleItems=function(_maxWidth,_activeItemIndex){var visibleItems=[],elementsSize=getElementsSize(),sum=elementsSize[_activeItemIndex]+getMoreElementSize()+40;visibleItems.push(_activeItemIndex);for(var items=root.querySelectorAll("li[data-menu-item][role=presentation]"),i=0;i<items.length;i++)if(i!==_activeItemIndex){if(sum+=elementsSize[i],sum>_maxWidth)return visibleItems;visibleItems.push(i)}return visibleItems},getActiveItemIndex=function(){for(var items=root.querySelectorAll("li[data-menu-item][role=presentation]"),i=0;i<items.length;i++)if(angular.element(items[i]).hasClass("df-tab-menu-active"))return i;return 0},buildMenu=function(){var maxWidth=root.offsetWidth,activeItemIndex=getActiveItemIndex(),visibleItems=getVisibleItems(maxWidth,activeItemIndex),elements=root.querySelectorAll("li[data-menu-item][role=presentation]"),moreElements=root.querySelectorAll("li[role=menuitem]"),moreMenuToggle=root.querySelector("li[data-more-menu-item]");if(visibleItems.length<root.querySelectorAll("li[data-menu-item][role=presentation]").length){angular.element(moreMenuToggle).removeClass("ng-hide").attr("aria-hidden","false");for(var i=0;i<elements.length;i++)-1!==visibleItems.indexOf(i)?(angular.element(elements[i]).removeClass("ng-hide").attr("aria-hidden","false"),angular.element(moreElements[i]).addClass("ng-hide").attr("aria-hidden","true")):(angular.element(elements[i]).addClass("ng-hide").attr("aria-hidden","true"),angular.element(moreElements[i]).removeClass("ng-hide").attr("aria-hidden","false"))}else angular.element(moreMenuToggle).addClass("ng-hide").attr("aria-hidden","true"),angular.element(elements).removeClass("ng-hide").attr("aria-hidden","false"),dropdownOpen=!1,drawDropDown();angular.element(moreMenuToggle).removeClass("invisible").attr("aria-hidden","false")},closeDropdown=function(e){dropdownOpen=!1,drawDropDown(e)},drawDropDown=function(){dropdownOpen?(addBootstrapTheme&&angular.element(root.querySelector("li[data-more-menu-item]")).addClass("open"),angular.element(root.querySelector("li[data-more-menu-item] [dropdown-toggle]")).addClass("df-tab-menu-dropdown-open").attr({"aria-expanded":"true"}),angular.element(doc).bind("click",closeDropdown)):(addBootstrapTheme&&angular.element(root.querySelector("li[data-more-menu-item]")).removeClass("open"),angular.element(root.querySelector("li[data-more-menu-item] [dropdown-toggle]")).removeClass("df-tab-menu-dropdown-open").attr({"aria-expanded":"false"}),angular.element(doc).unbind("click",closeDropdown))},toggleDropdown=function(e){e&&e.stopPropagation(),dropdownOpen=!dropdownOpen,drawDropDown()};angular.element(root.querySelector("li[data-more-menu-item] [dropdown-toggle]")).bind("click",toggleDropdown);var updateActiveState=function(c){var e1=angular.element(root.querySelector("li.df-tab-menu-active")).removeClass("df-tab-menu-active");e1.children().attr("aria-selected","false");var e2=angular.element(root.querySelector('li[data-menu-item="'+c+'"][role=presentation]')).addClass("df-tab-menu-active");e2.children().attr("aria-selected","true"),addBootstrapTheme&&(e1.removeClass("active"),e2.addClass("active"))};$attrs.$observe("menuControl",function(c){buildMenu(),updateActiveState(c)}),wdw.bind("resize",buildMenu),$scope.$on("$destroy",function(){wdw.unbind("resize",buildMenu),angular.element(root.querySelector("li[data-more-menu-item] [dropdown-toggle]")).unbind("click",toggleDropdown),angular.element(doc).unbind("click",closeDropdown)});var buildMenuTimeout=null,runBuildTimeoutDebounce=function(){$timeout.cancel(buildMenuTimeout),buildMenuTimeout=$timeout(function(){buildMenu(),updateActiveState($attrs.menuControl)},200,!1)},runBuildTimeout=function(){$timeout(function(){buildMenu(),updateActiveState($attrs.menuControl)},0,!1)},clearScopeWatcher=null,temporaryScopeWatch=function(){var scopeWatcher=$scope.$watch(function(){runBuildTimeoutDebounce()});$timeout.cancel(clearScopeWatcher),clearScopeWatcher=$timeout(function(){scopeWatcher()},5e3,!1)};haparaClientBus.register({key:"hapara-shared-group-view-change",scope:$scope},function(view){var moreMenuToggle=root.querySelector("li[data-more-menu-item]");angular.element(moreMenuToggle).addClass("invisible").attr("aria-hidden","true"),runBuildTimeout(),temporaryScopeWatch()})}}}}])}();